<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Proxy n8n Chat (mínimo)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css" />
  <style>html,body{height:100%;margin:0}#chat{height:100vh}</style>
</head>
<body>
  <div id="chat"></div>
  <script type="module">
    import { createChat } from 'https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js';

    // 1) Lee y normaliza el prefill
    const q = new URLSearchParams(location.search).get('q') || '';
    const prefill = String(q).slice(0, 800);

    // 2) Construye initialMessages (si hay prefill)
    const initialMessages = prefill ? [{ role: 'user', text: prefill }] : [];

    // 3) Metadata (solo strings)
    const metadata = {
      q: prefill,
      sessionId: (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()),
      source: 'proxy-github-pages',
      startedAt: new Date().toISOString(),
    };

    // 4) Crea el chat
    const chat = createChat({
      target: '#chat',
      webhookUrl: 'https://analitekinr.app.n8n.cloud/webhook/03f593e9-b2f4-48a3-98a7-ceadb57aaf32/chat',
      title: 'Soporte Analitek Industrial Research',
      subtitle: '¿En qué te ayudo hoy?',
      defaultPlaceholder: 'Escribe tu consulta...',
      allowFileUploads: false,
      loadPreviousSession: false,   // evita estados previos corruptos
      metadata,
      initialMessages,
    });

    // 5) (Opcional) abrir automáticamente
    // chat?.open?.();
  </script>
</body>
</html>
