<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Soporte Analitek Industrial Research</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css" />
  <style>
    html,body{height:100%;margin:0;background:#fff;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif}
    #chat{height:100vh;width:100vw}
    #diag{position:fixed;left:8px;bottom:8px;background:#000;color:#fff;padding:8px 10px;border-radius:8px;font-size:12px;opacity:.85;z-index:99999}
    .hide{display:none}
    .n8n-chat-launcher{z-index:99998 !important}
  </style>
</head>
<body>
  <div id="chat"></div>
  <div id="diag">Cargando…</div>

  <script type="module">
    const log = (m)=>{ console.log("[proxy]", m); const el=document.getElementById('diag'); if(el){ el.textContent=m; } };
    const wait = (ms)=>new Promise(r=>setTimeout(r,ms));

    import { createChat } from 'https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js';

    const q = new URLSearchParams(location.search).get('q') || '';
    const prefill = String(q).slice(0,800).trim();

    // Crear chat (sin initialMessages). Intentamos forzar embebido si la versión lo soporta.
    let chat;
    try {
      chat = createChat({
        target: '#chat',
        webhookUrl: 'https://analitekinr.app.n8n.cloud/webhook/03f593e9-b2f4-48a3-98a7-ceadb57aaf32/chat',
        title: 'Soporte Analitek Industrial Research',
        subtitle: '¿En qué te ayudo hoy?',
        defaultPlaceholder: 'Escribe tu consulta…',
        allowFileUploads: false,
        loadPreviousSession: false,
        // Estas props son compatibles en varias builds; si no las soporta, simplemente se ignoran
        layout: { mode: 'embedded' },
        launcher: { visible: false },
        metadata: {
          q: prefill,
          sessionId: (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()),
          source: 'proxy-github-pages',
          startedAt: new Date().toISOString(),
        }
      });
      log("createChat OK; abriendo…");
    } catch(e) {
      log("Error creando chat: "+ e.message);
    }

    // Abrir con varios intentos
    let opened = false;

    async function tryOpenSequence() {
      // 1) Intentar chat.open()
      if (chat && typeof chat.open === 'function') {
        try {
          chat.open();
          opened = true;
          log("chat.open() invocado");
        } catch(e) {
          log("chat.open() lanzó error: " + e.message);
        }
      }

      // 2) Si no abrió, intentar click al launcher varias veces
      if (!opened) {
        log("Intentando click al launcher…");
        for (let i=0;i<40 && !opened;i++) {
          const btn = document.querySelector(
            '[data-testid="n8n-chat-launcher"], .n8n-chat-launcher, button[title*="chat"], button[aria-label*="chat"], button[aria-label*="Chat"]'
          );
          if (btn) {
            btn.click();
            opened = true;
            log("Launcher clickeado");
            break;
          }
          await wait(100);
        }
      }

      // 3) Si sigue sin abrir, forzamos un toque al contenedor (algunas builds reaccionan al foco)
      if (!opened) {
        const host = document.querySelector('#chat');
        host?.click?.();
        log("Click sobre #chat para forzar render");
      }
    }

    await tryOpenSequence();

    // Enviar prefill cuando detectemos input & botón
    function sendPrefillOnce() {
      if (!prefill) return;
      let sent = false;

      const trySend = ()=>{
        const input = document.querySelector('textarea, [data-testid="n8n-chat-input"]');
        const send  = document.querySelector('[data-testid="n8n-chat-send"], .n8n-chat-send, button[aria-label*="Enviar"], button[type="submit"]');

        if (!sent && input && send) {
          if ('value' in input) input.value = prefill;
          input.dispatchEvent(new Event('input', { bubbles:true }));
          send.click();
          sent = true;
          log('Prefill enviado: "'+prefill+'"');
          setTimeout(()=>document.getElementById('diag')?.classList.add('hide'), 1500);
        }
      };

      // 1) Reintentos cortos
      let ticks = 0;
      const rafLoop = ()=>{
        if (sent) return;
        trySend();
        if (++ticks < 120) requestAnimationFrame(rafLoop);
      };
      rafLoop();

      // 2) Observador de DOM por si el input aparece después
      const obs = new MutationObserver(()=>{
        if (!sent) trySend();
        if (sent) obs.disconnect();
      });
      obs.observe(document.body, { childList:true, subtree:true });

      // 3) Failsafe: segundo grupo de intentos a intervalos
      const id = setInterval(()=>{
        if (sent) { clearInterval(id); return; }
        trySend();
      }, 250);
      setTimeout(()=>clearInterval(id), 10000);
    }

    sendPrefillOnce();

    // Ocultar diagnóstico si no hay prefill
    if (!prefill) setTimeout(()=>document.getElementById('diag')?.classList.add('hide'), 1200);
  </script>
</body>
</html>
